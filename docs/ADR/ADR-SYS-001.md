# 외부 API 연동 테스트 환경 구축 전략

| 문서 ID       | ADR-TEST-001  |
| :------------ |:--------------|
| **문서 버전** | 1.0           |
| **프로젝트** | AssetMind     |
| **작성자** | 이재석           |
| **작성일** | 2026년 01월 07일 |

## 1. 배경 및 맥락 (Context)

본 프로젝트는 주식 시세 조회 및 주문 실행을 위해 **한국투자증권(KIS) Open API** 등 외부 써드파티(3rd-party) 서비스에 강하게 의존하고 있다. 외부 API를 사용하는 코드를 테스트할 때 다음과 같은 문제점이 식별되었다.

**주요 제약 사항 및 요구사항:**

1.  **비결정적(Non-deterministic) 환경:** 외부 서버의 점검이나 네트워크 상태에 따라 테스트 결과가 달라져, CI/CD 파이프라인의 신뢰성을 떨어뜨린다.
2.  **비용 및 제한:** API 호출 횟수 제한(Rate Limit)이 존재하며, 무분별한 테스트 호출은 실제 운영 환경에 영향을 주거나 계정 차단을 유발할 수 있다.
3.  **장애 상황 재현 불가:** 연결 거부(Connection Refused), 타임아웃, 응답 지연, 잘못된 JSON 응답 등 장애 상황(Edge Case)을 실제 서버로는 강제로 재현하기 어렵다.

## 2. 결정 사항 (Decision)

우리는 **외부 의존성이 없는 독립적인 테스트 환경 구축**을 목표로, `Infrastructure Layer`의 HTTP 통신(Adapter) 검증을 위해 **`OkHttp MockWebServer`** 라이브러리를 표준으로 채택한다.

### 2.1. 계층별 테스트 전략 (Testing Strategy)

| 계층 (Layer)      | 대상 컴포넌트                          | 테스트 도구       | 역할 및 범위                                                                                                         |
| :---------------- | :------------------------------------- | :---------------- | :------------------------------------------------------------------------------------------------------------------- |
| **Service Layer** | `MarketAccessService`                  | **Mockito** | 비즈니스 로직 검증. (예: 토큰이 없을 때 Adapter를 호출하는가? 예외 발생 시 재시도하는가?)                            |
| **Adapter Layer** | `KisAuthAdapter`<br>`KisStockAdapter` | **MockWebServer** | HTTP 통신 규격 검증. (예: 요청 헤더가 올바른가? JSON 파싱이 잘 되는가? 네트워크 에러 시 예외 처리가 되는가?) |

### 2.2. MockWebServer 선정 근거

-   **WebClient와의 호환성:** Spring WebFlux의 `WebClient`는 비동기/체이닝 방식으로 동작하여 `Mockito`로 모킹(Mocking) 할 경우 설정 복잡도가 매우 높다. 반면, `MockWebServer`는 실제 소켓 통신을 하므로 WebClient 코드를 수정 없이 그대로 테스트할 수 있다.
-   **정교한 시뮬레이션:** `SocketPolicy` 설정을 통해 연결 끊김, 지연(Delay) 등 네트워크 레벨의 장애 상황을 코드로 제어할 수 있다.

## 3. 상세 기술 구현 지침 (Technical Guidelines)

본 결정에 따라 외부 API 연동 코드 작성 및 테스트 시 다음 사항을 준수해야 한다.

1.  **Request 검증 의무화:** 단순히 응답(Response)만 테스트하는 것이 아니라, `mockWebServer.takeRequest()`를 사용하여 우리 서버가 보낸 요청의 **URL, HTTP Method, Header, Body(JSON)**가 규격에 맞는지 검증해야 한다.
2.  **장애 시나리오 포함:** `shutdown()`(서버 다운) 또는 `SocketPolicy.DISCONNECT_AT_START`(연결 끊김)을 활용하여, 네트워크 재앙 상황에서도 애플리케이션이 적절한 예외(`MarketAccessFailedException` 등)를 던지는지 확인해야 한다.
3.  **환경 변수 주입:** 테스트 환경(`test`)에서는 `ReflectionTestUtils` 등을 활용하여 API Base URL을 `localhost` (MockWebServer 포트)로 교체하여 실행한다.

## 4. 결과 (Consequences)

이 결정을 통해 얻게 되는 이득(Pros)과 감수해야 할 비용(Cons)은 다음과 같다.

### 긍정적 효과 (Pros)

-   **테스트 신뢰성 확보:** 외부 서버 상태와 무관하게 **항상 성공하는(Deterministic)** 테스트 환경을 구축하여 CI/CD 안정성을 보장한다.
-   **안전성(Safety):** 테스트 실행 중 실수로 매수/매도 주문이 전송되거나, 잘못된 API Key 노출로 인한 보안 사고를 원천 차단한다.
-   **테스트 속도 향상:** 실제 네트워크를 타지 않고 로컬 메모리 상에서 통신하므로 테스트 실행 속도가 비약적으로 빠르다.
-   **개발 속도 향상:** `WebClient`의 메서드 체이닝을 `Mockito`로만 구현 했을 때의 테스트 코드 작성 시간이 많지만 해당 부분을 `MockWebServer` 라이브러리를 통해 이를 단축함으로써 개발자는 꼭 필요한 테스트 로직에 집중할 수 있고 개발의 효율성이 증가한다.

### 부정적 효과 및 대응 (Cons & Mitigation)

-   **보일러플레이트 코드:** 각 테스트마다 가짜 응답(JSON String)을 작성해야 하는 번거로움이 있다.
    -   _대응:_ 자주 쓰는 응답(성공/실패)은 별도의 `Fixture` 클래스나 유틸리티 메서드로 분리하여 재사용성을 높인다.
-   **실제 API 변경 감지 불가:** KIS 측에서 API 스펙을 예고 없이 변경할 경우, Mock 테스트는 통과하지만 운영 환경에서는 실패할 수 있다.
    -   _대응:_ 이는 단위 테스트의 영역이 아니므로, 별도의 통합 테스트(Integration Test) 단계나 모니터링 시스템을 통해 보완한다.